<script>
    class TodoItem extends HTMLElement {

        constructor(){
            super();
        }
        
        get todo(){
            return this.getAttribute('todo') || this._todo;
        }

        set todo(value){
            this._todo = value;
        }

        get selected(){
            return this._selected;
        }

        set selected(value){
            this.updateSelection(value);
        }

        update(){
            if(this.todo == undefined){
                this.updateValues('', undefined);
                return;
            }

            this.updateValues(this.todo.description, this.todo.completed);
        }

        updateValues(content, checked){
            this.todoContent.dataset.content = content;
            this.switch.checked = checked;
        }

        connectedCallback() {
            this.listItem = document.createElement('li');
            this.listItem.className = 'list-item';
            this.listItem.innerHTML = '<div id="text"></div><input id="switch" type="checkbox">';
            this.todoContent = this.listItem.querySelector('#text');
            this.switch = this.listItem.querySelector('#switch');
            this.appendChild(this.listItem);
            this.update();
            this.addEventListeners();
        }

        addEventListeners(){
            this.itemSelectedEventListener = this.itemSelected.bind(this);
            this.switch.addEventListener('click', this.itemSelectedEventListener);
            this.todoSelectedEventListener = this.todoSelected.bind(this);
            this.addEventListener('click', this.todoSelectedEventListener)
        }

        removeEventListeners(){
            this.switch.removeEventListeners('click', this.itemSelectedEventListener);
            delete this.itemSelectedEventListener;
            this.removeEventListener('click', this.todoSelectedEventListener);
            delete this.todoSelectedEventListener;
        }

        disconnectionedCallback() {
            removeEventListeners();
            delete this.listItem;
            delete this.switch;
            delete this.todoContent;
        }

        itemSelected(event){
            this.todo.completed = this.switch.checked;
            event.stopPropagation();
            return false;
        }

        todoSelected(event){
            const multiSelect = event.shiftKey;
            const selected = !this.selected;
            this.updateSelection(selected);

            this.dispatchEvent(new CustomEvent(TodoItem.selectionChanged, {bubbles: true, detail: {obj: this, multiSelect: multiSelect}}));
        }

        updateSelection(selected){
            this._selected = selected;
            this.todoContent.dataset.selected = selected;
        }

        static selectionChanged(){
            return 'TodoSelected';
        }
    }

    customElements.define("to-do-item", TodoItem);
</script>